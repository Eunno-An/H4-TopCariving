import { CarModel, Flex, Tag, Text } from '@components/common';
import { ImgTag, InfoBox } from '../Trim/Engine';
import { useEffect, useState } from 'react';
import styled from '@emotion/styled';
import { theme } from '@styles/theme';
import check from '@assets/images/blueCheck.svg';
import { exteriorColorType, useMyCar } from '@contexts/MyCarContext';
import { css } from '@emotion/react';

interface colorResponseInterface {
  carOptionId: number;
  colorUrl: string;
  price: number;
  tagResponses: {
    tagContent: string;
  }[];
}
interface exteriorColorResponseInterface extends colorResponseInterface {
  optionName: exteriorColorType;
}

interface interiorColorResponseInterface extends colorResponseInterface {
  optionName: string;
  photoUrl: string;
}

export type colorKey = 'exteriorColorResponses' | 'interiorColorResponses';

interface colorInfoInterface {
  exteriorColorResponses: exteriorColorResponseInterface[];
  interiorColorResponses: interiorColorResponseInterface[];
}

export const colorPath = {
  Ïñ¥ÎπÑÏä§Î∏îÎûôÌéÑ: 'black',
  'Ïâ¨Î®∏ÎßÅ Ïã§Î≤Ñ Î©îÌÉàÎ¶≠': 'silver',
  'Î¨∏ÎùºÏù¥ÌîÑ Î∏îÎ£® ÌéÑ': 'blue',
  'Í∞ÄÏù¥ÏïÑ Î∏åÎùºÏö¥ ÌéÑ': 'brown',
  'Í∑∏ÎùºÌååÏù¥Ìä∏ Í∑∏Î†àÏù¥ Î©îÌÉàÎ¶≠': 'gray',
  'ÌÅ¨Î¶¨ÎØ∏ ÌôîÏù¥Ìä∏ ÌéÑ': 'white',
} as { [key in exteriorColorType]: string };

const Color = () => {
  const { myCarInfo, setMyCarInfo } = useMyCar();
  const [selectedColorIdx, setSelectedColorIdx] = useState<{
    [key in colorKey]: number;
  }>({
    exteriorColorResponses: 0,
    interiorColorResponses: 0,
  });
  const [isLastClick, setIsLastClick] = useState<{
    key: keyof colorInfoInterface;
    idx: number;
  }>({
    key: 'exteriorColorResponses',
    idx: 0,
  });
  const [modelColor, setModelColor] = useState('black');

  useEffect(() => {
    const getData = async () => {
      if (colorInfo) {
        if (myCarInfo.color.exteriorColor === null) {
          setMyCarInfo({
            ...myCarInfo,
            price:
              myCarInfo.price +
              colorInfo.exteriorColorResponses[0].price +
              colorInfo.interiorColorResponses[0].price,
            color: {
              exteriorColor: {
                id: colorInfo.exteriorColorResponses[0].carOptionId,
                name: colorInfo.exteriorColorResponses[0].optionName,
              },
              interiorColor: {
                id: colorInfo.interiorColorResponses[0].carOptionId,
                name: colorInfo.interiorColorResponses[0].optionName,
              },
            },
          });
        } else {
          let [exteriorIdx, interiorIdx] = [0, 0];
          colorInfo.exteriorColorResponses.forEach((exColor, idx) => {
            if (exColor.optionName === myCarInfo.color.exteriorColor?.name) {
              exteriorIdx = idx;
            }
          });
          colorInfo.interiorColorResponses.forEach((interColor, idx) => {
            if (interColor.optionName === myCarInfo.color.interiorColor?.name) {
              interiorIdx = idx;
            }
          });
          setSelectedColorIdx({
            interiorColorResponses: interiorIdx,
            exteriorColorResponses: exteriorIdx,
          });
        }
      }
    };
    getData();
  }, []);

  const onClickColorBox = (colorKey: colorKey, idx: number) => {
    const changeColorKey =
      colorKey === 'exteriorColorResponses' ? 'exteriorColor' : 'interiorColor';

    console.log();
    setMyCarInfo({
      ...myCarInfo,
      color: {
        ...myCarInfo.color,
        [changeColorKey]: {
          id: colorInfo[colorKey][idx].carOptionId,
          name: colorInfo[colorKey][idx].optionName,
        },
      },
      price:
        myCarInfo.price -
        colorInfo[colorKey][selectedColorIdx[colorKey]].price +
        colorInfo[colorKey][idx].price,
    });

    setIsLastClick({
      key: colorKey as colorKey,
      idx: idx,
    });

    if (colorKey === 'exteriorColorResponses') {
      setModelColor(
        colorPath[colorInfo.exteriorColorResponses[idx].optionName],
      );
    }

    const newSelectedColor = selectedColorIdx;
    selectedColorIdx[colorKey] = idx;
    setSelectedColorIdx(newSelectedColor);
  };

  return (
    <Flex gap={28} padding="28px 0 0 0" align="flex-start">
      <Flex direction="column" gap={23} height="auto">
        <Flex width={620} height={397} align="center">
          {isLastClick.key === 'exteriorColorResponses' ? (
            <CarModel exteriorColor={modelColor} />
          ) : (
            <ImgTag
              src={colorInfo[isLastClick.key][isLastClick.idx].photoUrl}
              alt=""
            />
          )}
        </Flex>
        <Flex width={620} direction="column" justify="space-between">
          <InfoBox justify="space-between" align="flex-start" height={48}>
            <Text typo="Heading1_Bold">
              {colorInfo[isLastClick.key][isLastClick.idx].optionName}
            </Text>
            <Text typo="Heading2_Bold">
              {`+${colorInfo[isLastClick.key][
                isLastClick.idx
              ].price.toLocaleString('ko-KR')}Ïõê`}
            </Text>
          </InfoBox>
        </Flex>
        <Flex
          justify="flex-start"
          css={css`
            flex-wrap: wrap;
            gap: 4px;
          `}
        >
          {colorInfo[isLastClick.key][isLastClick.idx].tagResponses.map(
            (tag, idx) => (
              <Tag desc={tag.tagContent} key={`tag_${idx}`} />
            ),
          )}
        </Flex>
      </Flex>

      <Flex direction="column" justify="flex-start">
        <Flex
          direction="column"
          justify="flex-start"
          gap={12}
          width={331}
          height="auto"
        >
          <Flex justify="space-between">
            <Text typo="Heading4_Medium">Ïô∏Ïû• ÏÉâÏÉÅ</Text>
            <Text typo="Body4_Regular">
              {
                colorInfo.exteriorColorResponses[
                  selectedColorIdx.exteriorColorResponses
                ].optionName
              }
            </Text>
          </Flex>
          <Line />
          <GridContainer>
            {colorInfo.exteriorColorResponses.map((item, idx) => (
              <Flex direction="column" justify="flex-start" gap={8}>
                <ColorWrapper
                  isSelected={selectedColorIdx.exteriorColorResponses === idx}
                >
                  <ExteriorColor
                    src={item.colorUrl}
                    onClick={() => {
                      onClickColorBox('exteriorColorResponses', idx);
                    }}
                  />
                  <BlueCheck
                    src={check}
                    type={'exteriorColorResponses'}
                    isSelected={selectedColorIdx.exteriorColorResponses === idx}
                  />
                </ColorWrapper>

                <Text typo="Body4_Regular">{item.optionName}</Text>
              </Flex>
            ))}
          </GridContainer>
        </Flex>
        <Flex
          direction="column"
          justify="flex-start"
          gap={12}
          width={331}
          height="auto"
        >
          <Flex justify="space-between">
            <Text typo="Heading4_Medium">ÎÇ¥Ïû• ÏÉâÏÉÅ</Text>
            <Text typo="Body4_Regular">
              {
                colorInfo.exteriorColorResponses[
                  selectedColorIdx.interiorColorResponses
                ].optionName
              }
            </Text>
          </Flex>
          <Line />
          <Flex direction="column" gap={16}>
            {colorInfo.interiorColorResponses.map((item, idx) => (
              <ColorWrapper
                key={`interiorCard_${idx}`}
                isSelected={selectedColorIdx.interiorColorResponses === idx}
              >
                <InteriorColor
                  src={item.colorUrl}
                  onClick={() => {
                    onClickColorBox('interiorColorResponses', idx);
                  }}
                />
                <BlueCheck
                  src={check}
                  type={'interiorColorResponses'}
                  isSelected={selectedColorIdx.interiorColorResponses === idx}
                />
              </ColorWrapper>
            ))}
          </Flex>
        </Flex>
      </Flex>
    </Flex>
  );
};

const GridContainer = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3Í∞úÏùò Ïó¥, Í∞Å Ïó¥ÏùÄ ÎèôÏùºÌïú ÎÑàÎπÑ */
  grid-template-rows: repeat(2, 1fr); /* 2Í∞úÏùò Ìñâ, Í∞Å ÌñâÏùÄ 200px ÎÜíÏù¥ */
  gap: 11px; /* Ïó¥Í≥º Ìñâ ÏÇ¨Ïù¥Ïùò Í∞ÑÍ≤© */
`;

const ColorWrapper = styled.div<{ isSelected: boolean }>`
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  border: ${(props) =>
    props.isSelected
      ? `3px solid ${theme.palette.ActiveBlue}`
      : `3px solid ${theme.palette.White}`};

  border-radius: 8px;
  box-sizing: border-box;
`;

const ExteriorColor = styled.img`
  width: 89px;
  height: 89px;
  background: #f0f2f1;
  cursor: pointer;

  border-radius: 6px;
`;

const InteriorColor = styled.img`
  width: 100%;
  border-radius: 6px;
  cursor: pointer;
`;

const BlueCheck = styled.img<{ type: colorKey; isSelected: boolean }>`
  position: absolute;
  top: -11px;
  right: -11px;

  width: 22px;
  height: 22px;

  display: ${(props) => (props.isSelected ? 'block' : 'none')};
`;

const Line = styled.div`
  height: 2px;
  width: 100%;
  background-color: ${theme.palette.LightSand};
`;

const colorInfo = {
  exteriorColorResponses: [
    {
      carOptionId: 11,
      optionName: 'Ïñ¥ÎπÑÏä§Î∏îÎûôÌéÑ',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/external_color/black.png',
      price: 0,
      tagResponses: [
        {
          tagContent: 'Ïù¥Í≤ÉÎßå ÏûàÏúºÎ©¥ ÎÇòÎèÑ Ï£ºÏ∞®Í≥†Ïàòüöò',
        },
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ©üëäüèª',
        },
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ©‚≠êÔ∏è',
        },
        {
          tagContent: 'Ïù¥Í≤ÉÎßå ÏûàÏúºÎ©¥ ÎÇòÎèÑ Ï£ºÏ∞®Í≥†Ïàòüöò',
        },
        {
          tagContent: 'Ïù¥Í≤ÉÎßå ÏûàÏúºÎ©¥ ÎÇòÎèÑ Ï£ºÏ∞®Í≥†Ïàòüöò',
        },
        {
          tagContent: 'Ìé∏Î¶¨Ìï¥Ïöîüòâ',
        },
        {
          tagContent: 'Ìé∏Î¶¨Ìï¥Ïöîüòâ',
        },
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ© ÏÑ§Î™Ö',
        },
      ],
    },
    {
      carOptionId: 11,
      optionName: 'Ïâ¨Î®∏ÎßÅ Ïã§Î≤Ñ Î©îÌÉàÎ¶≠',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/external_color/silver.png',
      price: 0,
      tagResponses: [
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ© ÏÑ§Î™Ö',
        },
      ],
    },
    {
      carOptionId: 11,
      optionName: 'Î¨∏ÎùºÏù¥ÌîÑ Î∏îÎ£® ÌéÑ',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/external_color/blue.png',
      price: 0,
      tagResponses: [
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ© ÏÑ§Î™Ö',
        },
      ],
    },
    {
      carOptionId: 11,
      optionName: 'Í∞ÄÏù¥ÏïÑ Î∏åÎùºÏö¥ ÌéÑ',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/external_color/brown.png',
      price: 0,
      tagResponses: [
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ© ÏÑ§Î™Ö',
        },
      ],
    },
    {
      carOptionId: 11,
      optionName: 'Í∑∏ÎùºÌååÏù¥Ìä∏ Í∑∏Î†àÏù¥ Î©îÌÉàÎ¶≠',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/external_color/gray.png',
      price: 300000,
      tagResponses: [
        {
          tagContent: 'ÌÉúÍ∑∏Ïπ© ÏÑ§Î™Ö',
        },
      ],
    },
    {
      carOptionId: 11,
      optionName: 'ÌÅ¨Î¶¨ÎØ∏ ÌôîÏù¥Ìä∏ ÌéÑ',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/external_color/white.png',
      price: 1200000,
      tagResponses: [
        {
          tagContent: 'string',
        },
      ],
    },
  ],
  interiorColorResponses: [
    {
      carOptionId: 11,
      optionName: 'ÌÄÑÌåÖÏ≤úÏó∞(Î∏îÎûô)',
      photoUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/internal_color/black_internal.png',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/internal_color/black.png',
      price: 300000,
      tagResponses: [
        {
          tagContent: 'string',
        },
      ],
    },
    {
      carOptionId: 11,
      optionName: 'Ïø®Í∑∏Î†àÏù¥',
      photoUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/internal_color/gray_internal.png',
      colorUrl:
        'https://topcariving.s3.ap-northeast-2.amazonaws.com/internal_color/gray.png',
      price: 400000,
      tagResponses: [
        {
          tagContent: 'string',
        },
      ],
    },
  ],
} as colorInfoInterface;

export default Color;
